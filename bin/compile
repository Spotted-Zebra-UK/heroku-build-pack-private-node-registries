#!/usr/bin/env bash

set -e
set -o pipefail

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

echo 'Setting up private NPM registries.' | indent

readonly BUILD_DIR=$1

if [[ ! -n "${BUILD_DIR}" ]]; then
  echo "Failed! No build directory specified." | indent
  exit 1
fi

cd ${BUILD_DIR}

# Serialized registries are passed as an environment variable
NPM_REGISTRIES=${NPM_REGISTRIES}

# Check if NPM_REGISTRIES is not set or is empty
if [ -z "${NPM_REGISTRIES}" ]; then
  echo "Skipping creation of .yarnrc.yml as NPM_REGISTRIES is not set." | indent
  exit 0
fi

cat >> .yarnrc.yml << EOL
npmScopes:
EOL

# Convert the semi-colon separated string into array of multiple registries
IFS=';' read -ra REGISTRIES <<< "$NPM_REGISTRIES"

for registry in "${REGISTRIES[@]}"; do
  # Convert the pipe separated string into array of registry, scope and token
  IFS='|' read -ra SCOPE <<< "$registry"
  cat >> .yarnrc.yml << EOL
  ${SCOPE[0]}:
    npmAuthToken: "${SCOPE[2]}"
    npmRegistryServer: "${SCOPE[1]}"
EOL
done

echo "Done!" | indent
exit 0
